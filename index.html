<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriScan - Smart Pantry Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #00ff00, transparent);
            animation: scan 2s ease-in-out infinite;
        }
        @keyframes scan {
            0%, 100% { top: 0; }
            50% { top: 100%; }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        video {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold">ü•ó NutriScan</h1>
                <button id="menuBtn" class="text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-md mb-6 overflow-x-auto">
            <div class="flex border-b">
                <button class="tab-btn px-6 py-3 font-semibold border-b-2 border-purple-600 text-purple-600" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600" data-tab="scan">Scan Barcode</button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600" data-tab="ocr">Scan Package</button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600" data-tab="pantry">Pantry</button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600" data-tab="recipes">Recipes</button>
                <button class="tab-btn px-6 py-3 font-semibold text-gray-600 hover:text-purple-600" data-tab="budget">Budget</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                    <h3 class="text-lg font-semibold mb-2">Total Items</h3>
                    <p class="text-4xl font-bold" id="totalItems">0</p>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white">
                    <h3 class="text-lg font-semibold mb-2">Expiring Soon</h3>
                    <p class="text-4xl font-bold" id="expiringSoon">0</p>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
                    <h3 class="text-lg font-semibold mb-2">Total Budget</h3>
                    <p class="text-4xl font-bold">‚Çπ<span id="totalBudget">0.00</span></p>
                </div>
            </div>

            <!-- Expiry Alerts -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üîî Expiry Alerts</h2>
                <div id="expiryAlerts" class="space-y-3"></div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Quick Actions</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="switchTab('scan')" class="bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition">
                        üì± Scan Barcode
                    </button>
                    <button onclick="switchTab('ocr')" class="bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition">
                        üì∏ Scan Package
                    </button>
                    <button onclick="showManualEntry()" class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition">
                        ‚úèÔ∏è Add Manual
                    </button>
                    <button onclick="switchTab('recipes')" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition">
                        üç≥ Get Recipes
                    </button>
                </div>
            </div>
        </div>

        <!-- Barcode Scanner Tab -->
        <div id="scan-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üì± Scan Barcode (Front Package)</h2>
                <div class="mb-4">
                    <button id="startScanBtn" class="bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition w-full md:w-auto">
                        Start Camera
                    </button>
                    <button id="stopScanBtn" class="bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition w-full md:w-auto ml-0 md:ml-2 mt-2 md:mt-0 hidden">
                        Stop Camera
                    </button>
                </div>
                <div id="scannerContainer" class="relative hidden mb-4">
                    <video id="barcodeVideo" class="w-full rounded-lg" autoplay playsinline></video>
                    <div class="scan-line"></div>
                </div>
                <div id="barcodeResult" class="hidden"></div>
            </div>
        </div>

        <!-- OCR Scanner Tab -->
        <div id="ocr-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üì∏ Scan Package Back (Nutritional Info)</h2>
                <p class="text-gray-600 mb-4">Take a photo of the nutritional information on the back of the package</p>
                <div class="mb-4">
                    <input type="file" id="ocrImageInput" accept="image/*" capture="environment" class="hidden">
                    <button onclick="document.getElementById('ocrImageInput').click()" class="bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 transition">
                        üì∑ Take/Upload Photo
                    </button>
                </div>
                <div id="ocrProgress" class="hidden mb-4">
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="ocrProgressBar" class="bg-indigo-600 h-4 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p class="text-center text-gray-600 mt-2" id="ocrProgressText">Processing...</p>
                </div>
                <div id="ocrImagePreview" class="mb-4"></div>
                <div id="ocrResult" class="hidden"></div>
            </div>
        </div>

        <!-- Pantry Tab -->
        <div id="pantry-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">üè™ My Pantry</h2>
                    <button onclick="showManualEntry()" class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition">
                        + Add Item
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="searchPantry" placeholder="Search items..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                </div>
                <div id="pantryList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Recipes Tab -->
        <div id="recipes-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üç≥ Recipe Suggestions</h2>
                <p class="text-gray-600 mb-4">Based on your pantry items</p>
                <button onclick="generateRecipes()" class="bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition mb-4">
                    üîç Find Recipes
                </button>
                <div id="recipesList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- Budget Tab -->
        <div id="budget-tab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">üí∞ Budget Tracker</h2>
                <div class="mb-6">
                    <canvas id="budgetChart" class="w-full" height="200"></canvas>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">This Month</h3>
                        <p class="text-3xl font-bold text-blue-600">‚Çπ<span id="monthlyBudget">0.00</span></p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">Average Item Cost</h3>
                        <p class="text-3xl font-bold text-green-600">‚Çπ<span id="avgItemCost">0.00</span></p>
                    </div>
                </div>
                <div id="budgetBreakdown" class="mt-6"></div>
            </div>
        </div>
    </div>

    <!-- Manual Entry Modal -->
    <div id="manualEntryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Add Item Manually</h2>
                    <button onclick="closeManualEntry()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="manualEntryForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Item Name *</label>
                        <input type="text" id="itemName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Quantity *</label>
                            <input type="number" id="itemQuantity" min="1" value="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Price (‚Çπ) *</label>
                            <input type="number" id="itemPrice" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Expiry Date *</label>
                        <input type="date" id="itemExpiry" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Location (Optional)</label>
                        <input type="text" id="itemLocation" placeholder="e.g., Kitchen cabinet, Fridge top shelf" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Calories (per 100g)</label>
                            <input type="number" id="itemCalories" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Protein (g)</label>
                            <input type="number" id="itemProtein" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Carbs (g)</label>
                            <input type="number" id="itemCarbs" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Fat (g)</label>
                            <input type="number" id="itemFat" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Ingredients</label>
                        <textarea id="itemIngredients" rows="2" placeholder="List ingredients..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition font-semibold">
                            Add to Pantry
                        </button>
                        <button type="button" onclick="closeManualEntry()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Item Detail Modal -->
    <div id="itemDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6" id="itemDetailContent"></div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

    <script>
        // Global Variables
        let pantryItems = JSON.parse(localStorage.getItem('pantryItems')) || [];
        let codeReader = null;
        let currentStream = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupTabs();
            updateDashboard();
            checkExpiryAlerts();
            requestNotificationPermission();
            setupExpiryCheckInterval();
            
            // Set minimum date for expiry to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('itemExpiry').setAttribute('min', today);
        });

        // Tab Management
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'text-purple-600');
                btn.classList.add('text-gray-600');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('border-purple-600', 'text-purple-600');
                activeBtn.classList.remove('text-gray-600');
            }

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            const activeTab = document.getElementById(`${tabName}-tab`);
            if (activeTab) {
                activeTab.classList.remove('hidden');
            }

            // Stop camera if switching away from scan tab
            if (tabName !== 'scan' && currentStream) {
                stopBarcodeScanner();
            }
        }

        // Barcode Scanner
        document.getElementById('startScanBtn').addEventListener('click', startBarcodeScanner);
        document.getElementById('stopScanBtn').addEventListener('click', stopBarcodeScanner);

        async function startBarcodeScanner() {
            try {
                const video = document.getElementById('barcodeVideo');
                const container = document.getElementById('scannerContainer');
                
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = currentStream;
                
                container.classList.remove('hidden');
                document.getElementById('startScanBtn').classList.add('hidden');
                document.getElementById('stopScanBtn').classList.remove('hidden');

                codeReader = new ZXing.BrowserMultiFormatReader();
                
                codeReader.decodeFromVideoDevice(null, 'barcodeVideo', async (result, err) => {
                    if (result) {
                        const barcode = result.text;
                        showNotification('Barcode detected: ' + barcode, 'success');
                        await fetchProductData(barcode);
                        stopBarcodeScanner();
                    }
                });
            } catch (error) {
                showNotification('Error accessing camera: ' + error.message, 'error');
            }
        }

        function stopBarcodeScanner() {
            if (codeReader) {
                codeReader.reset();
            }
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('scannerContainer').classList.add('hidden');
            document.getElementById('startScanBtn').classList.remove('hidden');
            document.getElementById('stopScanBtn').classList.add('hidden');
        }

        async function fetchProductData(barcode) {
            try {
                showNotification('Fetching product data...', 'info');
                const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${barcode}.json`);
                const data = await response.json();
                
                if (data.status === 1) {
                    displayProductData(data.product);
                } else {
                    showNotification('Product not found. Please enter manually.', 'warning');
                    showManualEntry();
                }
            } catch (error) {
                showNotification('Error fetching product: ' + error.message, 'error');
                showManualEntry();
            }
        }

        function displayProductData(product) {
            const resultDiv = document.getElementById('barcodeResult');
            const nutrients = product.nutriments || {};
            
            const calories = (nutrients['energy-kcal_100g'] || 0).toFixed(2);
            const protein = (nutrients.proteins_100g || 0).toFixed(2);
            const carbs = (nutrients.carbohydrates_100g || 0).toFixed(2);
            const fat = (nutrients.fat_100g || 0).toFixed(2);
            
            resultDiv.innerHTML = `
                <div class="bg-gradient-to-br from-purple-50 to-blue-50 p-6 rounded-lg border-2 border-purple-200">
                    <div class="flex items-start gap-4 mb-4">
                        ${product.image_url ? `<img src="${product.image_url}" class="w-24 h-24 object-cover rounded-lg">` : ''}
                        <div class="flex-1">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${product.product_name || 'Unknown Product'}</h3>
                            <p class="text-gray-600">${product.brands || ''}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Calories</p>
                            <p class="text-xl font-bold text-purple-600">${calories}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Protein</p>
                            <p class="text-xl font-bold text-blue-600">${protein}g</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Carbs</p>
                            <p class="text-xl font-bold text-green-600">${carbs}g</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Fat</p>
                            <p class="text-xl font-bold text-orange-600">${fat}g</p>
                        </div>
                    </div>

                    ${product.ingredients_text ? `
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üß™ Ingredients:</h4>
                        <p class="text-sm text-gray-700">${product.ingredients_text}</p>
                    </div>` : ''}

                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">ü§ñ AI Health Advice:</h4>
                        <p class="text-sm text-gray-700">${generateHealthAdvice(product)}</p>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">üí° Fun Fact:</h4>
                        <p class="text-sm text-gray-700">${generateFunFact(product)}</p>
                    </div>
                    
                    <form onsubmit="addScannedItem(event, ${JSON.stringify(product).replace(/"/g, '&quot;')})" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Quantity</label>
                                <input type="number" name="quantity" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Price (‚Çπ)</label>
                                <input type="number" name="price" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Expiry Date</label>
                            <input type="date" name="expiry" required min="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Storage Location (Optional)</label>
                            <input type="text" name="location" placeholder="e.g., Kitchen cabinet, Fridge" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition font-semibold">
                            Add to Pantry
                        </button>
                    </form>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        function addScannedItem(event, product) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const nutrients = product.nutriments || {};
            const item = {
                id: Date.now(),
                name: product.product_name || 'Unknown Product',
                quantity: parseInt(formData.get('quantity')),
                price: parseFloat(formData.get('price')),
                expiry: formData.get('expiry'),
                location: formData.get('location') || '',
                calories: (nutrients['energy-kcal_100g'] || 0).toFixed(2),
                protein: (nutrients.proteins_100g || 0).toFixed(2),
                carbs: (nutrients.carbohydrates_100g || 0).toFixed(2),
                fat: (nutrients.fat_100g || 0).toFixed(2),
                ingredients: product.ingredients_text || '',
                image: product.image_url || '',
                addedDate: new Date().toISOString()
            };
            
            pantryItems.push(item);
            savePantryItems();
            showNotification(`${item.name} added to pantry!`, 'success');
            updateDashboard();
            switchTab('pantry');
        }

        // OCR Scanner
        document.getElementById('ocrImageInput').addEventListener('change', handleOCRImage);

        async function handleOCRImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const preview = document.getElementById('ocrImagePreview');
            const progress = document.getElementById('ocrProgress');
            const progressBar = document.getElementById('ocrProgressBar');
            const progressText = document.getElementById('ocrProgressText');
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="max-w-full rounded-lg shadow-lg">`;
            };
            reader.readAsDataURL(file);
            
            // Show progress
            progress.classList.remove('hidden');
            progressBar.style.width = '0%';
            
            try {
                const result = await Tesseract.recognize(file, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const percent = Math.round(m.progress * 100);
                            progressBar.style.width = percent + '%';
                            progressText.textContent = `Processing... ${percent}%`;
                        }
                    }
                });
                
                progress.classList.add('hidden');
                extractNutritionalInfo(result.data.text);
            } catch (error) {
                progress.classList.add('hidden');
                showNotification('Error processing image: ' + error.message, 'error');
            }
        }

        function extractNutritionalInfo(text) {
            const resultDiv = document.getElementById('ocrResult');
            
            // Extract nutritional values using regex
            const caloriesMatch = text.match(/(?:energy|calories?)[\s:]*(\d+\.?\d*)/i);
            const proteinMatch = text.match(/protein[\s:]*(\d+\.?\d*)/i);
            const carbsMatch = text.match(/(?:carbohydrate|carbs?)[\s:]*(\d+\.?\d*)/i);
            const fatMatch = text.match(/(?:fat|fats?)[\s:]*(\d+\.?\d*)/i);
            const priceMatch = text.match(/(?:‚Çπ|rs\.?|inr)[\s]*(\d+\.?\d*)/i);
            
            const calories = caloriesMatch ? parseFloat(caloriesMatch[1]).toFixed(2) : '0.00';
            const protein = proteinMatch ? parseFloat(proteinMatch[1]).toFixed(2) : '0.00';
            const carbs = carbsMatch ? parseFloat(carbsMatch[1]).toFixed(2) : '0.00';
            const fat = fatMatch ? parseFloat(fatMatch[1]).toFixed(2) : '0.00';
            const price = priceMatch ? parseFloat(priceMatch[1]).toFixed(2) : '';
            
            resultDiv.innerHTML = `
                <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-6 rounded-lg border-2 border-indigo-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Extracted Information</h3>
                    
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h4 class="font-semibold text-gray-800 mb-2">Raw Text:</h4>
                        <p class="text-sm text-gray-700 max-h-40 overflow-y-auto">${text}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Calories</p>
                            <p class="text-xl font-bold text-purple-600">${calories}</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Protein</p>
                            <p class="text-xl font-bold text-blue-600">${protein}g</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Carbs</p>
                            <p class="text-xl font-bold text-green-600">${carbs}g</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg shadow">
                            <p class="text-xs text-gray-600">Fat</p>
                            <p class="text-xl font-bold text-orange-600">${fat}g</p>
                        </div>
                    </div>
                    
                    <form onsubmit="addOCRItem(event, '${calories}', '${protein}', '${carbs}', '${fat}', '${price}')" class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Product Name</label>
                            <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Quantity</label>
                                <input type="number" name="quantity" min="1" value="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Price (‚Çπ)</label>
                                <input type="number" name="price" step="0.01" value="${price}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Expiry Date</label>
                            <input type="date" name="expiry" required min="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Storage Location (Optional)</label>
                            <input type="text" name="location" placeholder="e.g., Kitchen cabinet" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Ingredients</label>
                            <textarea name="ingredients" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg hover:bg-indigo-700 transition font-semibold">
                            Add to Pantry
                        </button>
                    </form>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        function addOCRItem(event, calories, protein, carbs, fat, price) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const item = {
                id: Date.now(),
                name: formData.get('name'),
                quantity: parseInt(formData.get('quantity')),
                price: parseFloat(formData.get('price')),
                expiry: formData.get('expiry'),
                location: formData.get('location') || '',
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                ingredients: formData.get('ingredients') || '',
                image: '',
                addedDate: new Date().toISOString()
            };
            
            pantryItems.push(item);
            savePantryItems();
            showNotification(`${item.name} added to pantry!`, 'success');
            updateDashboard();
            switchTab('pantry');
        }

        // Manual Entry
        function showManualEntry() {
            document.getElementById('manualEntryModal').classList.remove('hidden');
            document.getElementById('manualEntryModal').classList.add('flex');
        }

        function closeManualEntry() {
            document.getElementById('manualEntryModal').classList.add('hidden');
            document.getElementById('manualEntryModal').classList.remove('flex');
            document.getElementById('manualEntryForm').reset();
        }

        document.getElementById('manualEntryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const item = {
                id: Date.now(),
                name: formData.get('itemName') || document.getElementById('itemName').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                price: parseFloat(document.getElementById('itemPrice').value),
                expiry: document.getElementById('itemExpiry').value,
                location: document.getElementById('itemLocation').value || '',
                calories: parseFloat(document.getElementById('itemCalories').value || 0).toFixed(2),
                protein: parseFloat(document.getElementById('itemProtein').value || 0).toFixed(2),
                carbs: parseFloat(document.getElementById('itemCarbs').value || 0).toFixed(2),
                fat: parseFloat(document.getElementById('itemFat').value || 0).toFixed(2),
                ingredients: document.getElementById('itemIngredients').value || '',
                image: '',
                addedDate: new Date().toISOString()
            };
            
            pantryItems.push(item);
            savePantryItems();
            showNotification(`${item.name} added to pantry!`, 'success');
            closeManualEntry();
            updateDashboard();
            updatePantryList();
        });

        // Pantry Management
        function updatePantryList() {
            const listDiv = document.getElementById('pantryList');
            const searchTerm = document.getElementById('searchPantry').value.toLowerCase();
            
            const filteredItems = pantryItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredItems.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No items in pantry. Start scanning or add manually!</p>';
                return;
            }
            
            listDiv.innerHTML = filteredItems.map(item => {
                const daysUntilExpiry = Math.ceil((new Date(item.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                let expiryClass = 'bg-green-100 text-green-800';
                if (daysUntilExpiry <= 3) expiryClass = 'bg-red-100 text-red-800';
                else if (daysUntilExpiry <= 7) expiryClass = 'bg-yellow-100 text-yellow-800';
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg transition">
                        <div class="flex items-start gap-4">
                            ${item.image ? `<img src="${item.image}" class="w-16 h-16 object-cover rounded-lg">` : 
                            '<div class="w-16 h-16 bg-gradient-to-br from-purple-400 to-blue-500 rounded-lg flex items-center justify-center text-white text-2xl">üçΩÔ∏è</div>'}
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${expiryClass}">
                                        ${daysUntilExpiry} days left
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2 text-sm">
                                    <div><span class="text-gray-600">Qty:</span> <span class="font-semibold">${item.quantity}</span></div>
                                    <div><span class="text-gray-600">Price:</span> <span class="font-semibold">‚Çπ${item.price.toFixed(2)}</span></div>
                                    <div><span class="text-gray-600">Calories:</span> <span class="font-semibold">${item.calories}</span></div>
                                    <div><span class="text-gray-600">Protein:</span> <span class="font-semibold">${item.protein}g</span></div>
                                </div>
                                ${item.location ? `<p class="text-sm text-gray-600 mb-2">üìç ${item.location}</p>` : ''}
                                <div class="flex gap-2 flex-wrap">
                                    <button onclick="viewItemDetails(${item.id})" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition">
                                        View Details
                                    </button>
                                    <button onclick="addMoreQuantity(${item.id})" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition">
                                        + Add More
                                    </button>
                                    <button onclick="deleteItem(${item.id})" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('searchPantry').addEventListener('input', updatePantryList);

        function viewItemDetails(id) {
            const item = pantryItems.find(i => i.id === id);
            if (!item) return;
            
            const modal = document.getElementById('itemDetailModal');
            const content = document.getElementById('itemDetailContent');
            
            content.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">${item.name}</h2>
                    <button onclick="closeItemDetail()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                ${item.image ? `<img src="${item.image}" class="w-full h-48 object-cover rounded-lg mb-4">` : ''}
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Calories (per 100g)</p>
                        <p class="text-2xl font-bold text-purple-600">${item.calories}</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Protein</p>
                        <p class="text-2xl font-bold text-blue-600">${item.protein}g</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Carbs</p>
                        <p class="text-2xl font-bold text-green-600">${item.carbs}g</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">Fat</p>
                        <p class="text-2xl font-bold text-orange-600">${item.fat}g</p>
                    </div>
                </div>
                
                <div class="space-y-3 mb-4">
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Quantity</p>
                        <p class="font-semibold">${item.quantity}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Price</p>
                        <p class="font-semibold">‚Çπ${item.price.toFixed(2)}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Expiry Date</p>
                        <p class="font-semibold">${new Date(item.expiry).toLocaleDateString()}</p>
                    </div>
                    ${item.location ? `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <p class="text-sm text-gray-600">Storage Location</p>
                        <p class="font-semibold">üìç ${item.location}</p>
                    </div>` : ''}
                </div>
                
                ${item.ingredients ? `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">üß™ Ingredients</h4>
                    <p class="text-sm text-gray-700">${item.ingredients}</p>
                </div>` : ''}
                
                <div class="bg-green-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">ü§ñ AI Health Advice</h4>
                    <p class="text-sm text-gray-700">${generateHealthAdviceFromItem(item)}</p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">üí° Fun Fact</h4>
                    <p class="text-sm text-gray-700">${generateFunFactFromItem(item)}</p>
                </div>
                
                <button onclick="closeItemDetail()" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition">
                    Close
                </button>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeItemDetail() {
            document.getElementById('itemDetailModal').classList.add('hidden');
            document.getElementById('itemDetailModal').classList.remove('flex');
        }

        function addMoreQuantity(id) {
            const item = pantryItems.find(i => i.id === id);
            if (!item) return;
            
            const qty = prompt(`How many more ${item.name} do you want to add?`, '1');
            if (qty && !isNaN(qty) && parseInt(qty) > 0) {
                item.quantity += parseInt(qty);
                savePantryItems();
                showNotification(`Added ${qty} more ${item.name}`, 'success');
                updateDashboard();
                updatePantryList();
            }
        }

        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                pantryItems = pantryItems.filter(i => i.id !== id);
                savePantryItems();
                showNotification('Item deleted', 'success');
                updateDashboard();
                updatePantryList();
            }
        }

        // AI Advice & Fun Facts
        function generateHealthAdvice(product) {
            const nutrients = product.nutriments || {};
            const calories = nutrients['energy-kcal_100g'] || 0;
            const name = product.product_name?.toLowerCase() || '';
            
            if (name.includes('chips') || name.includes('namkeen')) {
                return "‚ö†Ô∏è Chips are high in sodium and fats. Enjoy in moderation! Try pairing with fresh vegetables to add fiber. Limit intake to once or twice a week for better health.";
            } else if (name.includes('biscuit') || name.includes('cookie')) {
                return "üç™ Biscuits often contain refined flour and sugar. Best enjoyed as an occasional treat. Pair with milk for added protein and calcium.";
            } else if (calories > 400) {
                return "‚ö° This is a high-calorie food. Consider portion control and balance with exercise. Great for energy, but watch your daily caloric intake!";
            } else if (calories < 100) {
                return "‚úÖ This is a low-calorie option! Great for weight management. Still ensure you're getting enough nutrients throughout the day.";
            }
            return "ü•ó Remember to maintain a balanced diet with plenty of fruits, vegetables, and whole grains. Moderation is key to healthy eating!";
        }

        function generateHealthAdviceFromItem(item) {
            const calories = parseFloat(item.calories) || 0;
            const name = item.name.toLowerCase();
            
            if (name.includes('chips') || name.includes('namkeen')) {
                return "‚ö†Ô∏è Chips are high in sodium and fats. Enjoy in moderation! Try pairing with fresh vegetables to add fiber. Limit intake to once or twice a week for better health.";
            } else if (name.includes('biscuit') || name.includes('cookie')) {
                return "üç™ Biscuits often contain refined flour and sugar. Best enjoyed as an occasional treat. Pair with milk for added protein and calcium.";
            } else if (calories > 400) {
                return "‚ö° This is a high-calorie food. Consider portion control and balance with exercise. Great for energy, but watch your daily caloric intake!";
            } else if (calories < 100) {
                return "‚úÖ This is a low-calorie option! Great for weight management. Still ensure you're getting enough nutrients throughout the day.";
            }
            return "ü•ó Remember to maintain a balanced diet with plenty of fruits, vegetables, and whole grains. Moderation is key to healthy eating!";
        }

        function generateFunFact(product) {
            const name = product.product_name?.toLowerCase() || '';
            const brand = product.brands?.toLowerCase() || '';
            
            if (name.includes('lays') || brand.includes('lays')) {
                return "Did you know? Lay's uses approximately 4.4 million pounds of potatoes every day! That's enough to fill 11 Olympic-sized swimming pools!";
            } else if (name.includes('kurkure')) {
                return "Fun fact: Kurkure was created specifically for the Indian market in 1999 and has become one of India's favorite snacks!";
            } else if (name.includes('maggi')) {
                return "Amazing fact: MAGGI noodles were created in Switzerland in 1863, but India is now one of its biggest markets with unique Indian flavors!";
            } else if (name.includes('oreo')) {
                return "Cookie trivia: Over 450 billion Oreo cookies have been sold since they were first introduced in 1912, making them the world's best-selling cookie!";
            } else if (name.includes('coca cola') || name.includes('coke')) {
                return "Refreshing fact: Coca-Cola is consumed more than 1.9 billion times per day across the globe!";
            }
            return "Interesting fact: The average person makes over 200 food-related decisions every day! Smart pantry management helps make better choices.";
        }

        function generateFunFactFromItem(item) {
            const name = item.name.toLowerCase();
            
            if (name.includes('potato')) {
                return "Did you know? Potatoes were the first vegetable to be grown in space! NASA and the University of Wisconsin created the technology with the goal of feeding astronauts on long space voyages.";
            } else if (name.includes('rice')) {
                return "Rice fact: There are over 40,000 varieties of rice in the world! India is home to more than 6,000 varieties.";
            } else if (name.includes('milk')) {
                return "Dairy delight: It takes about 345 squirts from a cow's udder to make a gallon of milk!";
            } else if (name.includes('chocolate')) {
                return "Sweet science: The smell of chocolate increases theta brain waves, triggering relaxation!";
            }
            return `${item.name} is a great addition to your pantry! Proper storage can extend its freshness and nutritional value.`;
        }

        // Dashboard Updates
        function updateDashboard() {
            // Total items
            const totalQty = pantryItems.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('totalItems').textContent = totalQty;
            
            // Expiring soon (within 7 days)
            const expiringCount = pantryItems.filter(item => {
                const daysUntilExpiry = Math.ceil((new Date(item.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                return daysUntilExpiry <= 7 && daysUntilExpiry >= 0;
            }).length;
            document.getElementById('expiringSoon').textContent = expiringCount;
            
            // Total budget
            const totalBudget = pantryItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('totalBudget').textContent = totalBudget.toFixed(2);
            
            // Update other views
            updateExpiryAlerts();
            updatePantryList();
            updateBudgetTracker();
        }

        function updateExpiryAlerts() {
            const alertsDiv = document.getElementById('expiryAlerts');
            const today = new Date();
            
            const expiringItems = pantryItems.filter(item => {
                const daysUntilExpiry = Math.ceil((new Date(item.expiry) - today) / (1000 * 60 * 60 * 24));
                return daysUntilExpiry <= 7 && daysUntilExpiry >= 0;
            }).sort((a, b) => new Date(a.expiry) - new Date(b.expiry));
            
            if (expiringItems.length === 0) {
                alertsDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No items expiring soon! üéâ</p>';
                return;
            }
            
            alertsDiv.innerHTML = expiringItems.map(item => {
                const daysUntilExpiry = Math.ceil((new Date(item.expiry) - today) / (1000 * 60 * 60 * 24));
                let alertClass = 'border-yellow-300 bg-yellow-50';
                let icon = '‚ö†Ô∏è';
                
                if (daysUntilExpiry <= 3) {
                    alertClass = 'border-red-300 bg-red-50';
                    icon = 'üö®';
                }
                
                return `
                    <div class="border-l-4 ${alertClass} p-4 rounded">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-semibold text-gray-800">${icon} ${item.name}</p>
                                <p class="text-sm text-gray-600">Expires in ${daysUntilExpiry} day(s) - ${new Date(item.expiry).toLocaleDateString()}</p>
                                ${item.location ? `<p class="text-xs text-gray-500">üìç ${item.location}</p>` : ''}
                            </div>
                            <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Recipe Generation
        function generateRecipes() {
            const recipesList = document.getElementById('recipesList');
            
            if (pantryItems.length === 0) {
                recipesList.innerHTML = '<p class="text-gray-500 text-center col-span-2">Add items to your pantry first!</p>';
                return;
            }
            
            // Simple recipe suggestions based on pantry items
            const ingredients = pantryItems.map(item => item.name).join(', ');
            
            const recipes = [
                {
                    name: "Quick Pantry Stir-Fry",
                    time: "20 mins",
                    difficulty: "Easy",
                    description: "Use your pantry vegetables and proteins for a quick, healthy stir-fry. Perfect for using items before they expire!",
                    ingredients: ["Vegetables from pantry", "Oil", "Soy sauce", "Garlic"]
                },
                {
                    name: "One-Pot Rice Bowl",
                    time: "30 mins",
                    difficulty: "Easy",
                    description: "Create a nutritious bowl using rice and any vegetables or proteins from your pantry.",
                    ingredients: ["Rice", "Mixed vegetables", "Spices", "Protein of choice"]
                },
                {
                    name: "Pantry Pasta",
                    time: "25 mins",
                    difficulty: "Easy",
                    description: "Transform your pantry staples into a delicious pasta dish.",
                    ingredients: ["Pasta", "Canned tomatoes", "Herbs", "Cheese"]
                },
                {
                    name: "Indian Dal Tadka",
                    time: "35 mins",
                    difficulty: "Medium",
                    description: "A classic Indian lentil dish that's protein-rich and uses common pantry spices.",
                    ingredients: ["Lentils", "Onions", "Tomatoes", "Spices"]
                }
            ];
            
            recipesList.innerHTML = recipes.map(recipe => `
                <div class="bg-white border border-gray-200 rounded-lg p-5 hover:shadow-lg transition">
                    <h3 class="text-xl font-bold text-gray-800 mb-2">${recipe.name}</h3>
                    <div class="flex gap-3 mb-3 text-sm">
                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">‚è±Ô∏è ${recipe.time}</span>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">üìä ${recipe.difficulty}</span>
                    </div>
                    <p class="text-gray-600 mb-3">${recipe.description}</p>
                    <div class="border-t pt-3">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Key Ingredients:</p>
                        <div class="flex flex-wrap gap-2">
                            ${recipe.ingredients.map(ing => `
                                <span class="px-2 py-1 bg-purple-50 text-purple-700 rounded text-xs">${ing}</span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Budget Tracker
        function updateBudgetTracker() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyItems = pantryItems.filter(item => {
                const itemDate = new Date(item.addedDate);
                return itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear;
            });
            
            const monthlyTotal = monthlyItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('monthlyBudget').textContent = monthlyTotal.toFixed(2);
            
            const avgCost = pantryItems.length > 0 
                ? pantryItems.reduce((sum, item) => sum + item.price, 0) / pantryItems.length 
                : 0;
            document.getElementById('avgItemCost').textContent = avgCost.toFixed(2);
            
            // Budget breakdown
            const breakdown = document.getElementById('budgetBreakdown');
            const categoryTotals = {};
            
            pantryItems.forEach(item => {
                const category = categorizeItem(item.name);
                categoryTotals[category] = (categoryTotals[category] || 0) + (item.price * item.quantity);
            });
            
            breakdown.innerHTML = `
                <h3 class="font-bold text-gray-800 mb-3">Budget Breakdown by Category</h3>
                <div class="space-y-2">
                    ${Object.entries(categoryTotals).map(([category, total]) => {
                        const percentage = (total / (document.getElementById('totalBudget').textContent || 1) * 100).toFixed(1);
                        return `
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="text-sm font-medium text-gray-700">${category}</span>
                                    <span class="text-sm font-semibold text-gray-800">‚Çπ${total.toFixed(2)} (${percentage}%)</span>
                                </div>
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function categorizeItem(name) {
            name = name.toLowerCase();
            if (name.includes('chips') || name.includes('snack') || name.includes('namkeen')) return 'Snacks';
            if (name.includes('milk') || name.includes('cheese') || name.includes('butter')) return 'Dairy';
            if (name.includes('rice') || name.includes('wheat') || name.includes('bread')) return 'Grains';
            if (name.includes('vegetable') || name.includes('fruit')) return 'Produce';
            if (name.includes('chicken') || name.includes('meat') || name.includes('fish')) return 'Protein';
            return 'Other';
        }

        // Notifications
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notif = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            notif.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg max-w-sm`;
            notif.textContent = message;
            
            container.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 4000);
        }

        function checkExpiryAlerts() {
            const today = new Date();
            
            pantryItems.forEach(item => {
                const expiryDate = new Date(item.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry === 3 || daysUntilExpiry === 1) {
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('‚ö†Ô∏è NutriScan Expiry Alert', {
                            body: `${item.name} expires in ${daysUntilExpiry} day(s)!${item.location ? ' Location: ' + item.location : ''}`,
                            icon: 'ü•ó'
                        });
                    }
                    showNotification(`‚ö†Ô∏è ${item.name} expires in ${daysUntilExpiry} day(s)!`, 'warning');
                }
            });
        }

        function setupExpiryCheckInterval() {
            // Check expiry every hour
            setInterval(checkExpiryAlerts, 60 * 60 * 1000);
            
            // Also check daily at 9 AM
            const now = new Date();
            const millisTill9AM = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0, 0) - now;
            const adjustedMillis = millisTill9AM < 0 ? millisTill9AM + 86400000 : millisTill9AM;
            
            setTimeout(() => {
                checkExpiryAlerts();
                setInterval(checkExpiryAlerts, 86400000); // Every 24 hours
            }, adjustedMillis);
        }

        // Data Persistence
        function savePantryItems() {
            localStorage.setItem('pantryItems', JSON.stringify(pantryItems));
        }

        // Initialize on load
        window.addEventListener('load', () => {
            updateDashboard();
        });
    </script>
</body>
</html>
